<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>MPHaven - Your Sanctuary</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #0f172a; }
        .container { width: 100%; height: 100vh; display: flex; flex-direction: column; }
        .app-wrapper { width: 100%; max-width: 28rem; height: 100%; margin: 0 auto; 
            background: rgba(15, 23, 42, 0.98); display: flex; flex-direction: column; 
            border-left: 1px solid rgba(30, 41, 59, 0.5); border-right: 1px solid rgba(30, 41, 59, 0.5); position: relative; }
        .bg-blur-1, .bg-blur-2 { position: absolute; border-radius: 50%; filter: blur(140px);
            pointer-events: none; z-index: 0; opacity: 0.6; }
        .bg-blur-1 { top: -5%; left: 50%; transform: translateX(-50%); width: 22rem; height: 22rem; 
            background: rgba(14, 116, 144, 0.08); }
        .bg-blur-2 { bottom: -5%; right: -5%; width: 18rem; height: 18rem; background: rgba(217, 119, 6, 0.08); }
        .main-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; 
            position: relative; z-index: 1; }
        .main-content::-webkit-scrollbar { display: none; }
        .content-wrapper { padding: 1rem 1.25rem 2rem; }
        .card { background: linear-gradient(135deg, rgba(30, 41, 59, 0.65), rgba(15, 23, 42, 0.45)); 
            border: 1px solid rgba(51, 65, 85, 0.4); border-radius: 1.25rem; }
        .skill-header { background: linear-gradient(135deg, #0e7490, #d97706); }
        .btn-primary { background: linear-gradient(to right, #0e7490, #d97706); color: white; font-weight: 600; 
            border: none; padding: 1rem; border-radius: 1rem; cursor: pointer; width: 100%; font-size: 1rem; 
            transition: all 0.3s ease; box-shadow: 0 4px 16px rgba(14, 116, 144, 0.2); }
        .btn-primary:hover, .btn-primary:active { opacity: 0.92; transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(14, 116, 144, 0.25); }
        .progress-dots { display: flex; gap: 0.25rem; }
        .progress-dot { flex: 1; height: 0.5rem; background: rgba(148, 163, 184, 0.25); border-radius: 9999px; }
        .progress-dot.active { background: linear-gradient(to right, #0e7490, #d97706); }
        .fade-in { animation: fadeIn 0.35s ease-out; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .timer-display { font-size: 4rem; font-weight: 700; background: linear-gradient(to right, #0e7490, #d97706); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .step-transition { animation: slideUp 0.4s ease-out; }
        .journal-textarea { width: 100%; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.4);
            border-radius: 0.75rem; padding: 1rem; color: white; font-size: 16px; min-height: 140px; 
            line-height: 1.6; margin-bottom: 1rem; resize: vertical; font-family: inherit; }
        .journal-textarea:focus { outline: none; border-color: rgba(14, 116, 144, 0.5); 
            background: rgba(30, 41, 59, 0.7); }
        .prompt-chip { display: inline-block; padding: 0.75rem 1.25rem; background: rgba(14, 116, 144, 0.1);
            border: 1px solid rgba(14, 116, 144, 0.3); border-radius: 9999px; color: rgb(165, 243, 252);
            font-size: 0.875rem; margin: 0.25rem; cursor: pointer; transition: all 0.2s ease; }
        .prompt-chip:active { background: rgba(14, 116, 144, 0.2); transform: translateY(-1px); }
        .text-primary { color: rgb(241, 245, 249); }
        .text-secondary { color: rgb(203, 213, 225); }
        .text-muted { color: rgb(148, 163, 184); }
        .text-teal-light { color: rgb(165, 243, 252); }
        .nav-bar { position: relative; z-index: 1000; border-top: 1px solid rgba(30, 41, 59, 0.5);
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(24px); 
            box-shadow: 0 -20px 25px -5px rgba(0, 0, 0, 0.3); flex-shrink: 0; padding: 0.75rem 0; }
        .nav-container { display: flex; align-items: center; justify-content: space-around; max-width: 28rem; margin: 0 auto; }
        .nav-btn { position: relative; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;
            padding: 0.5rem 1rem; background: none; border: none; cursor: pointer; transition: all 0.2s;
            -webkit-tap-highlight-color: rgba(0,0,0,0); min-width: 80px; min-height: 60px; }
        .nav-indicator { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2.5rem; 
            height: 3px; background: linear-gradient(to right, #0e7490, #d97706); border-radius: 9999px; }
        .nav-indicator.hidden { display: none; }
        .nav-icon { width: 24px; height: 24px; transition: all 0.2s; flex-shrink: 0; }
        .nav-icon.active { color: white !important; transform: scale(1.1); }
        .nav-icon.inactive { color: rgb(100, 116, 139) !important; }
        .nav-label { font-size: 0.6875rem; font-weight: 600; transition: all 0.2s; white-space: nowrap; }
        .nav-label.active { color: white !important; }
        .nav-label.inactive { color: rgb(100, 116, 139) !important; }
        .timer-badge { position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; border-radius: 50%;
            background: #d97706; opacity: 0; transition: opacity 0.3s ease; }
        .timer-badge.active { opacity: 1; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 9998;
            display: flex; align-items: center; justify-content: center; padding: 1.25rem; }
        .modal-content { background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(14, 116, 144, 0.3); border-radius: 1.5rem; padding: 2rem;
            max-width: 28rem; width: 100%; backdrop-filter: blur(10px); animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-wrapper">
            <div class="bg-blur-1"></div>
            <div class="bg-blur-2"></div>
            <div id="mainContent" class="main-content"></div>
            <div class="nav-bar">
                <div class="nav-container">
                    <button onclick="app.switchTab('home')" class="nav-btn" data-tab="home">
                        <div class="nav-indicator"></div>
                        <svg class="nav-icon active" stroke-width="2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        <span class="nav-label active">Home</span>
                    </button>
                    <button onclick="app.switchTab('paths')" class="nav-btn" data-tab="paths">
                        <div class="nav-indicator hidden"></div>
                        <svg class="nav-icon inactive" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <span class="nav-label inactive">Paths</span>
                    </button>
                    <button onclick="app.switchTab('you')" class="nav-btn" data-tab="you">
                        <div class="nav-indicator hidden"></div>
                        <svg class="nav-icon inactive" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span class="nav-label inactive">You</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="modalContainer"></div>

    <script src="lessons-data.js"></script>
    <script>
        const app = {
            state: {
                currentTab: 'home',
                currentCourse: null,
                userProgress: {},
                journalEntries: [],
                practiceTimerRunning: false,
                practiceSeconds: 0,
                practiceStartedAt: null,
                practiceSkill: null,
                practiceTargetTime: 30
            },
            
            saveState() { try { localStorage.setItem('mphaven_state', JSON.stringify(this.state)); } catch(e) {} },
            loadState() { try { const s = localStorage.getItem('mphaven_state'); 
                if(s) { const loaded = JSON.parse(s); this.state = {...this.state, ...loaded}; 
                if(this.state.practiceTimerRunning && this.state.practiceStartedAt) {
                    const elapsed = Math.floor((Date.now() - this.state.practiceStartedAt)/1000);
                    this.state.practiceSeconds = Math.min(elapsed, this.state.practiceTargetTime);
                    if(this.state.practiceSeconds >= this.state.practiceTargetTime) this.state.practiceTimerRunning = false;
                    else this.resumePracticeTimer(); }}} catch(e) {} },
            
            switchTab(tabName) { this.state.currentTab = tabName; this.saveState(); this.updateNav(tabName); 
                this.updateTimerBadge(); this.render(); },
            
            updateNav(tabName) {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const indicator = btn.querySelector('.nav-indicator');
                    const icon = btn.querySelector('.nav-icon');
                    const label = btn.querySelector('.nav-label');
                    const isActive = btn.dataset.tab === tabName;
                    if(isActive) { indicator.classList.remove('hidden'); icon.classList.remove('inactive');
                        icon.classList.add('active'); icon.setAttribute('stroke-width','2.5');
                        label.classList.remove('inactive'); label.classList.add('active'); }
                    else { indicator.classList.add('hidden'); icon.classList.remove('active');
                        icon.classList.add('inactive'); icon.setAttribute('stroke-width','2');
                        label.classList.remove('active'); label.classList.add('inactive'); }
                });
            },
            
            updateTimerBadge() {
                document.querySelectorAll('.timer-badge').forEach(badge => {
                    badge.classList.toggle('active', this.state.practiceTimerRunning);
                });
            },
            
            // SHOW SKILL OPTIONS MODAL (Like your original!)
            showSkillOptions(courseId, skillId) {
                const course = window.lessonsData[courseId];
                const skill = course.skills[skillId];
                
                const modal = `
                    <div class="modal-overlay" onclick="if(event.target===this) app.closeModal()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div style="text-align:center">
                                <div style="font-size:3rem;margin-bottom:1rem">${skill.icon}</div>
                                <h2 class="text-primary" style="font-size:1.75rem;font-weight:700;margin-bottom:0.5rem">${skill.name}</h2>
                                <p class="text-secondary" style="margin-bottom:1.5rem;font-size:0.875rem">${skill.tagline}</p>
                                
                                <div style="text-align:left;margin-bottom:1.5rem">
                                    <p class="text-secondary" style="font-size:1rem;line-height:1.6">${skill.description}</p>
                                </div>
                                
                                <div style="text-align:left;background:rgba(14,116,144,0.08);padding:1rem;border-radius:1rem;margin-bottom:1.5rem;border-left:3px solid rgba(14,116,144,0.4)">
                                    <p style="color:rgb(165,243,252);font-weight:600;margin-bottom:0.5rem;font-size:0.9375rem">Why this works:</p>
                                    <p class="text-secondary" style="font-size:0.9375rem;line-height:1.6">${skill.why || 'Master this skill to deepen your practice.'}</p>
                                </div>
                                
                                <div style="display:grid;gap:0.75rem">
                                    <button onclick="app.startLesson('${courseId}','${skillId}')" class="btn-primary" style="display:flex;align-items:center;justify-content:center;gap:0.5rem">
                                        <svg style="width:1.25rem;height:1.25rem" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                        </svg>
                                        Learn This Skill
                                    </button>
                                    
                                    <button onclick="app.startPracticeFromModal('${courseId}','${skillId}')" style="width:100%;padding:1rem;border-radius:1rem;background:rgba(14,116,144,0.12);border:1px solid rgba(14,116,144,0.35);color:rgb(165,243,252);font-weight:600;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.5rem">
                                        <svg style="width:1.25rem;height:1.25rem" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Practice Now (${skill.practiceDuration}s)
                                    </button>
                                    
                                    <button onclick="app.closeModal()" style="width:100%;padding:0.75rem;border-radius:0.75rem;background:transparent;color:rgb(148,163,184);font-weight:500;border:none;font-size:0.875rem;cursor:pointer">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modal;
            },
            
            closeModal() { document.getElementById('modalContainer').innerHTML = ''; },
            
            startLesson(courseId, skillId) {
                this.closeModal();
                this.state.currentCourse = courseId;
                this.state.currentSkill = skillId;
                this.state.currentStep = 0;
                this.saveState();
                this.renderLesson();
            },
            
            startPracticeFromModal(courseId, skillId) {
                this.closeModal();
                const skill = window.lessonsData[courseId].skills[skillId];
                this.state.practiceSkill = skillId;
                this.state.practiceTargetTime = skill.practiceDuration || 30;
                this.state.practiceSeconds = 0;
                this.state.practiceTimerRunning = true;
                this.state.practiceStartedAt = Date.now();
                this.saveState();
                this.updateTimerBadge();
                this.switchTab('you'); // Switch to You tab for standalone practice
                this.startPracticeTimer();
            },
            
            nextStep() {
                const course = window.lessonsData[this.state.currentCourse];
                const skill = course.skills[this.state.currentSkill];
                
                if(this.state.currentStep < skill.steps.length - 1) {
                    this.state.currentStep++;
                    this.saveState();
                    this.renderLesson();
                } else {
                    confetti({particleCount:100,spread:70,origin:{y:0.6}});
                    if(!this.state.userProgress[this.state.currentSkill]) {
                        this.state.userProgress[this.state.currentSkill] = {completed:true,date:new Date().toISOString()};
                        this.saveState();
                    }
                    setTimeout(() => this.switchTab('home'), 1500);
                }
            },
            
            startPracticeTimer() {
                this.practiceInterval = setInterval(() => {
                    if(!this.state.practiceTimerRunning) { clearInterval(this.practiceInterval); return; }
                    const now = Date.now();
                    this.state.practiceSeconds = Math.floor((now - this.state.practiceStartedAt)/1000);
                    const display = document.getElementById('practiceTimerDisplay');
                    if(display) { const remaining = this.state.practiceTargetTime - this.state.practiceSeconds;
                        display.textContent = Math.max(0, remaining); }
                    if(this.state.practiceSeconds >= this.state.practiceTargetTime) this.stopPractice();
                    this.saveState();
                }, 1000);
            },
            
            resumePracticeTimer() { if(this.state.practiceTimerRunning) this.startPracticeTimer(); },
            
            stopPractice() {
                this.state.practiceTimerRunning = false;
                this.state.practiceSeconds = Math.min(this.state.practiceSeconds, this.state.practiceTargetTime);
                if(this.practiceInterval) { clearInterval(this.practiceInterval); this.practiceInterval = null; }
                this.updateTimerBadge();
                this.saveState();
                setTimeout(() => this.render(), 500);
            },
            
            render() {
                const content = document.getElementById('mainContent');
                content.scrollTop = 0;
                
                if(this.state.currentSkill && this.state.currentCourse && this.state.currentTab === 'home') {
                    this.renderLesson();
                } else {
                    switch(this.state.currentTab) {
                        case 'home': this.renderHome(); break;
                        case 'paths': this.renderPaths(); break;
                        case 'you': this.renderYou(); break;
                        default: this.renderHome();
                    }
                }
            },
            
            renderHome() {
                const html = `
                    <div class="content-wrapper">
                        <div style="padding:2rem 0 1.5rem">
                            <h1 class="text-primary" style="font-size:2.5rem;font-weight:700;margin-bottom:0.5rem;line-height:1.1">
                                Welcome<br/>back
                            </h1>
                            <p class="text-secondary" style="font-size:1.125rem">Your sanctuary is here.</p>
                        </div>

                        <div style="margin-bottom:2rem">
                            <h2 class="text-muted" style="font-size:0.875rem;font-weight:600;margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.05em">
                                Continue
                            </h2>
                            
                            ${Object.values(window.lessonsData.mindfulness.skills).slice(0,2).map(skill => `
                                <div onclick="app.showSkillOptions('mindfulness','${skill.id}')" class="card" style="padding:1.5rem;margin-bottom:1rem;background:linear-gradient(135deg,rgba(14,116,144,0.15) 0%,rgba(14,116,144,0.05) 100%);border:2px solid rgba(14,116,144,0.5);cursor:pointer">
                                    <div style="display:flex;align-items:center;gap:1rem">
                                        <div style="width:3.5rem;height:3.5rem;background:#d97706;border-radius:1rem;display:flex;align-items:center;justify-content:center;color:white;font-size:1.75rem">${skill.icon}</div>
                                        <div style="flex:1">
                                            <h3 class="text-primary" style="font-size:1.25rem;font-weight:600;margin-bottom:0.25rem">${skill.name}</h3>
                                            <p class="text-secondary" style="font-size:0.875rem">${skill.tagline}</p>
                                        </div>
                                        <div style="width:2.5rem;height:2.5rem;border-radius:9999px;display:flex;align-items:center;justify-content:center;background:rgba(14,116,144,0.2)">
                                            <svg style="width:1.25rem;height:1.25rem;color:rgb(165,243,252)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div>
                            <h2 class="text-muted" style="font-size:0.875rem;font-weight:600;margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.05em">
                                Explore
                            </h2>
                            <button onclick="app.switchTab('paths')" class="card" style="padding:1rem;background:rgba(30,41,59,0.5);border:1px solid rgba(51,65,85,0.5);border-radius:1rem;cursor:pointer;width:100%">
                                <span class="text-primary" style="font-weight:600;font-size:1rem">View all paths</span>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = html;
            },
            
            renderPaths() {
                const courses = Object.values(window.lessonsData);
                const html = `
                    <div class="content-wrapper">
                        <div style="padding:1.5rem 0 1rem">
                            <h1 class="text-primary" style="font-size:2rem;font-weight:700;margin-bottom:0.5rem">Your Paths</h1>
                            <p class="text-secondary" style="font-size:1rem">Choose what speaks to you</p>
                        </div>
                        
                        ${courses.map(course => `
                            <div class="card" style="padding:1.5rem;margin-bottom:1rem">
                                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem">
                                    <div style="width:4rem;height:4rem;background:${course.color};border-radius:1rem;display:flex;align-items:center;justify-content:center;color:white;font-size:2rem">${course.icon}</div>
                                    <div style="flex:1">
                                        <h3 class="text-primary" style="font-size:1.25rem;font-weight:600;margin-bottom:0.25rem">${course.title}</h3>
                                        <p class="text-secondary" style="font-size:0.875rem">${course.description}</p>
                                    </div>
                                </div>
                                
                                <div style="display:flex;flex-direction:column;gap:0.75rem">
                                    ${Object.values(course.skills).map(skill => `
                                        <button onclick="app.showSkillOptions('${course.id}','${skill.id}')" class="card" style="padding:1rem;cursor:pointer;width:100%;text-align:left;background:rgba(30,41,59,0.3);border:1px solid rgba(71,85,105,0.3)">
                                            <div style="display:flex;align-items:center;gap:1rem">
                                                <div style="width:2.5rem;height:2.5rem;background:${course.color};border-radius:0.75rem;display:flex;align-items:center;justify-content:center;color:white;font-size:1.25rem">${skill.icon}</div>
                                                <div style="flex:1">
                                                    <h4 class="text-primary" style="font-weight:600;font-size:1rem;margin-bottom:0.125rem">${skill.name}</h4>
                                                    <p class="text-secondary" style="font-size:0.8125rem">${skill.tagline}</p>
                                                </div>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = html;
            },
            
            renderYou() {
                const completedCount = Object.values(this.state.userProgress).filter(p => p.completed).length;
                
                // Check if practice is running
                if(this.state.practiceTimerRunning && this.state.practiceSkill) {
                    const skill = Object.values(window.lessonsData).flatMap(c => Object.values(c.skills))
                        .find(s => s.id === this.state.practiceSkill);
                    const remaining = this.state.practiceTargetTime - this.state.practiceSeconds;
                    
                    const html = `
                        <div class="content-wrapper">
                            <div style="margin-bottom:2rem">
                                <h1 class="text-primary" style="font-size:2rem;font-weight:700;margin-bottom:0.5rem">
                                    ${skill ? skill.name : 'Practice'}
                                </h1>
                                <p class="text-secondary" style="font-size:1rem">
                                    ${skill ? skill.tagline : 'Focus on your practice'}
                                </p>
                            </div>
                            
                            <div class="card" style="padding:2rem;margin-bottom:1.5rem;text-align:center;background:linear-gradient(135deg,rgba(14,116,144,0.08),rgba(217,119,6,0.08))">
                                <div class="timer-display" id="practiceTimerDisplay" style="margin-bottom:1rem">${remaining}</div>
                                <p class="text-secondary" style="margin-bottom:1.5rem;font-size:1rem">
                                    Focus on your breath. When thoughts arise, just notice them.
                                </p>
                                <button onclick="app.stopPractice()" class="btn-primary" style="background:rgba(239,68,68,0.2);border:2px solid rgba(239,68,68,0.4);color:rgb(252,165,165)">
                                    ⏹️ Stop Practice
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('mainContent').innerHTML = html;
                } else {
                    const html = `
                        <div class="content-wrapper">
                            <div style="padding:1.5rem 0 1rem">
                                <h1 class="text-primary" style="font-size:2rem;font-weight:700;margin-bottom:0.5rem">You</h1>
                                <p class="text-secondary" style="font-size:1rem">Your mindfulness journey</p>
                            </div>
                            
                            <div class="card" style="padding:2rem;margin-bottom:2rem;background:rgba(14,116,144,0.1);border:1px solid rgba(14,116,144,0.2)">
                                <div class="text-teal-light" style="font-size:3rem;font-weight:700;margin-bottom:0.5rem;text-align:center">${completedCount}</div>
                                <div class="text-secondary" style="font-size:1rem;text-align:center">Skills Learned</div>
                            </div>
                            
                            <button onclick="if(confirm('Reset all progress?')){app.state.userProgress={};app.saveState();app.render()}" class="card" style="padding:1rem;text-align:left;border:1px solid rgba(239,68,68,0.3);color:rgb(254,202,202);font-weight:500;cursor:pointer;background:rgba(239,68,68,0.1);width:100%">
                                Reset Progress
                            </button>
                        </div>
                    `;
                    document.getElementById('mainContent').innerHTML = html;
                }
            },
            
            renderLesson() {
                const course = window.lessonsData[this.state.currentCourse];
                const skill = course.skills[this.state.currentSkill];
                const step = skill.steps[this.state.currentStep];
                const totalSteps = skill.steps.length;
                
                const html = `
                    <div class="step-transition">
                        <div class="card" style="padding:1rem;margin-bottom:1rem">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
                                <button onclick="app.state.currentSkill=null;app.state.currentCourse=null;app.switchTab('home')" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:0.25rem">←</button>
                                <h1 class="text-primary" style="font-weight:600;font-size:1.125rem">${step.title}</h1>
                                <div class="text-muted" style="font-size:0.875rem">${this.state.currentStep+1}/${totalSteps}</div>
                            </div>
                            <div class="progress-dots">
                                ${Array(totalSteps).fill().map((_,i) => `<div class="progress-dot ${i<=this.state.currentStep?'active':''}"></div>`).join('')}
                            </div>
                        </div>
                        ${step.renderContent()}
                        <div class="content-wrapper">
                            <button onclick="app.nextStep()" class="btn-primary" style="margin-bottom:1rem">
                                ${this.state.currentStep < totalSteps-1 ? 'Continue →' : 'Finish Lesson ✨'}
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = html;
                
                if(step.hasTimer) this.setupLessonTimer(step.timerDuration||30);
                if(step.hasPractice) this.setupPracticeInLesson(step.practiceDuration, step.practicePrompts);
            },
            
            setupLessonTimer(duration) {
                setTimeout(() => {
                    const button = document.getElementById('timerButton');
                    if(button) {
                        button.onclick = () => {
                            let timeLeft = duration;
                            const display = document.getElementById('timerDisplay');
                            button.disabled = true; button.textContent = 'Focus...'; button.style.opacity = '0.5';
                            const interval = setInterval(() => {
                                timeLeft--; display.textContent = timeLeft;
                                if(timeLeft <= 0) { clearInterval(interval); button.textContent = 'Complete!'; }
                            }, 1000);
                        };
                    }
                }, 100);
            },
            
            setupPracticeInLesson(duration, prompts) {
                setTimeout(() => {
                    const button = document.getElementById('practiceButton');
                    if(button) {
                        button.onclick = () => {
                            let timeLeft = duration; let promptIndex = 0;
                            const display = document.getElementById('practiceDisplay');
                            const promptEl = document.getElementById('practicePrompt');
                            button.disabled = true; button.textContent = 'Practicing...'; button.style.opacity = '0.5';
                            if(promptEl && prompts && prompts.length>0) 
                                promptEl.innerHTML = `<p style="color:rgb(165,243,252);font-style:italic;font-size:1.125rem;font-weight:500">${prompts[0]}</p>`;
                            const interval = setInterval(() => {
                                timeLeft--; display.textContent = timeLeft;
                                if(prompts && promptEl && timeLeft%8===0 && promptIndex<prompts.length-1) {
                                    promptIndex++;
                                    promptEl.innerHTML = `<p style="color:rgb(165,243,252);font-style:italic;font-size:1.125rem;font-weight:500">${prompts[promptIndex]}</p>`;
                                }
                                if(timeLeft <= 0) { clearInterval(interval);
                                    if(promptEl) promptEl.innerHTML = `<p style="color:rgb(134,239,172);font-weight:600;font-size:1.125rem">✨ Beautiful. Take a moment...</p>`;
                                    button.textContent = 'Complete!'; }
                            }, 1000);
                        };
                    }
                }, 100);
            },
            
            init() { this.loadState(); this.updateNav(this.state.currentTab); this.updateTimerBadge(); this.render(); }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
