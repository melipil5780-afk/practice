<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>MPHaven - Your Sanctuary</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="lessons-data.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body { 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background: #0f172a;
        }
        
        .container { 
            width: 100%; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        .app-wrapper { 
            width: 100%; 
            max-width: 28rem; 
            height: 100%; 
            margin: 0 auto; 
            background: rgba(15, 23, 42, 0.98); 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid rgba(30, 41, 59, 0.5); 
            border-right: 1px solid rgba(30, 41, 59, 0.5); 
        }
        
        .bg-blur-1, .bg-blur-2 { 
            position: absolute; 
            border-radius: 50%; 
            filter: blur(140px);
            pointer-events: none; 
            z-index: 0;
            opacity: 0.6;
        }
        
        .bg-blur-1 { 
            top: -5%; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 22rem; 
            height: 22rem; 
            background: rgba(14, 116, 144, 0.08);
        }
        
        .bg-blur-2 { 
            bottom: -5%; 
            right: -5%; 
            width: 18rem; 
            height: 18rem; 
            background: rgba(217, 119, 6, 0.08);
        }
        
        .main-content { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
            position: relative;
            z-index: 1;
        }
        
        .main-content::-webkit-scrollbar { 
            display: none; 
        }
        
        .content-wrapper { 
            padding: 1rem 1.25rem 2rem; 
        }
        
        .card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.65), rgba(15, 23, 42, 0.45)); 
            border: 1px solid rgba(51, 65, 85, 0.4); 
            border-radius: 1.25rem; 
        }
        
        .skill-header { 
            background: linear-gradient(135deg, #0e7490, #d97706);
        }
        
        .btn-primary { 
            background: linear-gradient(to right, #0e7490, #d97706); 
            color: white; 
            font-weight: 600; 
            border: none; 
            padding: 1rem; 
            border-radius: 1rem; 
            cursor: pointer; 
            width: 100%; 
            font-size: 1rem; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 16px rgba(14, 116, 144, 0.2);
        }
        
        .btn-primary:hover, .btn-primary:active { 
            opacity: 0.92; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(14, 116, 144, 0.25);
        }
        
        .progress-dots { 
            display: flex; 
            gap: 0.25rem; 
        }
        
        .progress-dot { 
            flex: 1; 
            height: 0.5rem; 
            background: rgba(148, 163, 184, 0.25); 
            border-radius: 9999px; 
        }
        
        .progress-dot.active { 
            background: linear-gradient(to right, #0e7490, #d97706); 
        }
        
        .fade-in { 
            animation: fadeIn 0.35s ease-out; 
        }
        
        .hidden { 
            display: none !important; 
        }
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(15px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(20px); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }
        
        .timer-display { 
            font-size: 4rem; 
            font-weight: 700; 
            background: linear-gradient(to right, #0e7490, #d97706); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
        }
        
        .checkbox-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.5rem; 
        }
        
        .checkbox-label { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            padding: 0.75rem; 
            background: rgba(30, 41, 59, 0.5); 
            border: 1px solid rgba(51, 65, 85, 0.4); 
            border-radius: 0.75rem; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .checkbox-label:hover, .checkbox-label:active { 
            border-color: rgba(14, 116, 144, 0.5); 
            background: rgba(14, 116, 144, 0.12); 
        }
        
        .step-transition { 
            animation: slideUp 0.4s ease-out; 
        }
        
        .text-primary { color: rgb(241, 245, 249); }
        .text-secondary { color: rgb(203, 213, 225); }
        .text-muted { color: rgb(148, 163, 184); }
        .text-teal-light { color: rgb(165, 243, 252); }
        .text-teal { color: rgb(94, 234, 212); }
        .text-amber-light { color: rgb(253, 230, 138); }
        .text-amber { color: rgb(251, 191, 36); }
        
        .nav-bar {
            position: relative;
            z-index: 1000;
            border-top: 1px solid rgba(30, 41, 59, 0.5);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(24px);
            box-shadow: 0 -20px 25px -5px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            padding: 0.75rem 0;
        }
        
        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-around;
            max-width: 28rem;
            margin: 0 auto;
        }
        
        .nav-btn {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            min-width: 80px;
            min-height: 60px;
        }
        
        .nav-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2.5rem;
            height: 3px;
            background: linear-gradient(to right, #0e7490, #d97706);
            border-radius: 9999px;
        }
        
        .nav-indicator.hidden {
            display: none;
        }
        
        .nav-icon {
            width: 24px;
            height: 24px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .nav-icon.active {
            color: white !important;
            transform: scale(1.1);
        }
        
        .nav-icon.inactive {
            color: rgb(100, 116, 139) !important;
        }
        
        .nav-label {
            font-size: 0.6875rem;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-label.active {
            color: white !important;
        }
        
        .nav-label.inactive {
            color: rgb(100, 116, 139) !important;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9998;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 1.25rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            opacity: 0;
            animation: fadeIn 0.2s ease-out forwards;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(14, 116, 144, 0.3);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 28rem;
            width: 100%;
            backdrop-filter: blur(10px);
            animation: slideUp 0.3s ease-out;
            margin: auto;
            margin-top: 2rem;
            margin-bottom: 2rem;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-wrapper" id="appWrapper">
            <div class="bg-blur-1"></div>
            <div class="bg-blur-2"></div>

            <div id="mainContent" class="main-content">
                <!-- Content loads here -->
            </div>

            <!-- Navigation -->
            <div class="nav-bar">
                <div class="nav-container">
                    <button onclick="switchTab('home')" class="nav-btn" data-tab="home">
                        <div class="nav-indicator"></div>
                        <svg class="nav-icon active" stroke-width="2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        <span class="nav-label active">Home</span>
                    </button>
                    
                    <button onclick="switchTab('courses')" class="nav-btn" data-tab="courses">
                        <div class="nav-indicator hidden"></div>
                        <svg class="nav-icon inactive" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <span class="nav-label inactive">Courses</span>
                    </button>
                    
                    <button onclick="switchTab('calendar')" class="nav-btn" data-tab="calendar">
                        <div class="nav-indicator hidden"></div>
                        <svg class="nav-icon inactive" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="nav-label inactive">Calendar</span>
                    </button>
                    
                    <button onclick="switchTab('you')" class="nav-btn" data-tab="you">
                        <div class="nav-indicator hidden"></div>
                        <svg class="nav-icon inactive" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span class="nav-label inactive">You</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalContainer" style="display: none;"></div>

    <script>
        // ===== APP STATE =====
        let state = {
            currentTab: 'home',
            currentCourse: null,
            currentSkill: null,
            currentStep: 1,
            userProgress: {},
            journalEntries: [],
            timerRunning: false
        };

        // ===== UTILITY FUNCTIONS =====
        function saveState() {
            try {
                localStorage.setItem('mphaven_state', JSON.stringify(state));
            } catch (e) {
                console.log('Failed to save state:', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('mphaven_state');
                if (saved) {
                    state = JSON.parse(saved);
                }
            } catch (e) {
                console.log('Failed to load state:', e);
            }
        }

        function showModal(html) {
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        ${html}
                    </div>
                </div>
            `;
            modalContainer.style.display = 'block';
        }

        function closeModal() {
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.style.display = 'none';
            modalContainer.innerHTML = '';
        }

        function scrollToTop() {
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.scrollTop = 0;
            }
        }

        // ===== CORE FUNCTIONS =====
        function switchTab(tabName) {
            if (state.currentTab === tabName) return;
            state.currentTab = tabName;
            state.currentSkill = null;
            state.currentStep = 1;
            saveState();
            
            // Update nav indicators
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const indicator = btn.querySelector('.nav-indicator');
                const icon = btn.querySelector('.nav-icon');
                const label = btn.querySelector('.nav-label');
                const isActive = btn.dataset.tab === tabName;
                
                if (isActive) {
                    indicator.classList.remove('hidden');
                    icon.classList.remove('inactive');
                    icon.classList.add('active');
                    icon.setAttribute('stroke-width', '2.5');
                    label.classList.remove('inactive');
                    label.classList.add('active');
                } else {
                    indicator.classList.add('hidden');
                    icon.classList.remove('active');
                    icon.classList.add('inactive');
                    icon.setAttribute('stroke-width', '2');
                    label.classList.remove('active');
                    label.classList.add('inactive');
                }
            });
            
            render();
        }

        function render() {
            const mainContent = document.getElementById('mainContent');
            mainContent.scrollTop = 0;
            
            switch(state.currentTab) {
                case 'home':
                    renderHome();
                    break;
                case 'courses':
                    renderCourses();
                    break;
                case 'calendar':
                    renderCalendar();
                    break;
                case 'you':
                    renderYou();
                    break;
                case 'lesson':
                    renderLesson();
                    break;
                case 'practice':
                    renderPractice();
                    break;
                default:
                    renderHome();
            }
        }

        // ===== HOME TAB =====
        function renderHome() {
            const mindfulnessSkills = window.skills.filter(skill => skill.courseId === 'mindfulness');
            
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="content-wrapper">
                    <div style="padding: 2rem 0 1.5rem">
                        <h1 class="text-primary" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.1">
                            Welcome<br/>back
                        </h1>
                        <p class="text-secondary" style="font-size: 1.125rem">
                            Your sanctuary is here.
                        </p>
                    </div>

                    <div style="margin-bottom: 2rem">
                        <h2 class="text-muted" style="font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em">
                            Continue
                        </h2>
                        
                        ${mindfulnessSkills.map(skill => `
                            <div onclick="showSkillOptions('${skill.id}')" class="card" style="padding: 1.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, rgba(14, 116, 144, 0.15) 0%, rgba(14, 116, 144, 0.05) 100%); border: 2px solid rgba(14, 116, 144, 0.5); cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 1rem">
                                    <div style="width: 3.5rem; height: 3.5rem; background: ${skill.color}; border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem">
                                        ${skill.icon}
                                    </div>
                                    
                                    <div style="flex: 1">
                                        <h3 class="text-primary" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem">
                                            ${skill.name}
                                        </h3>
                                        <p class="text-secondary" style="font-size: 0.875rem">
                                            ${skill.tagline}
                                        </p>
                                    </div>
                                    
                                    <div style="width: 2.5rem; height: 2.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; background: rgba(14, 116, 144, 0.2);">
                                        <svg style="width: 1.25rem; height: 1.25rem; color: rgb(165, 243, 252);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div>
                        <h2 class="text-muted" style="font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em">
                            Explore
                        </h2>
                        
                        <button onclick="switchTab('courses')" class="card" style="padding: 1rem; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; cursor: pointer; width: 100%;">
                            <span class="text-primary" style="font-weight: 600; font-size: 1rem">View all courses</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== COURSES TAB =====
        function renderCourses() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="content-wrapper">
                    <div style="padding: 1.5rem 0 1rem">
                        <h1 class="text-primary" style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem">
                            Courses
                        </h1>
                        <p class="text-secondary" style="font-size: 1rem">
                            Choose what speaks to you
                        </p>
                    </div>
                    
                    ${window.courses.map(course => `
                        <div onclick="openCourse('${course.id}')" class="card" style="padding: 1.5rem; margin-bottom: 1rem; cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 1rem">
                                <div style="width: 4rem; height: 4rem; background: ${course.color}; border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem">
                                    ${course.icon}
                                </div>
                                
                                <div style="flex: 1">
                                    <h3 class="text-primary" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem">
                                        ${course.title}
                                    </h3>
                                    <p class="text-secondary" style="font-size: 0.875rem">
                                        ${course.description}
                                    </p>
                                </div>
                                
                                <div style="padding: 0.5rem 1rem; border-radius: 9999px; background: ${course.color}40; color: white; font-size: 0.875rem; font-weight: 600">
                                    ${course.started ? 'Continue' : 'Begin'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openCourse(courseId) {
            state.currentCourse = courseId;
            const course = window.courses.find(c => c.id === courseId);
            const courseSkills = window.skills.filter(skill => skill.courseId === courseId);
            
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="content-wrapper">
                    <div style="margin-bottom: 2rem">
                        <button onclick="switchTab('courses')" style="background: none; border: none; color: white; font-size: 1.5rem; margin-bottom: 1rem; cursor: pointer">‚Üê</button>
                        <h1 class="text-primary" style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem">
                            ${course.title}
                        </h1>
                        <p class="text-secondary" style="font-size: 1rem">
                            ${course.description}
                        </p>
                    </div>
                    
                    <div>
                        ${courseSkills.map(skill => `
                            <button onclick="showSkillOptions('${skill.id}')" class="card" style="padding: 1.25rem; background: linear-gradient(135deg, rgba(30, 41, 59, 0.3), rgba(15, 23, 42, 0.2)); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 1.25rem; text-align: left; margin-bottom: 0.75rem; cursor: pointer; width: 100%;">
                                <div style="display: flex; align-items: start; gap: 1rem">
                                    <div style="width: 3rem; height: 3rem; border-radius: 0.875rem; background: ${skill.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0">
                                        ${skill.icon}
                                    </div>
                                    <div style="flex: 1">
                                        <h3 class="text-primary" style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.25rem">
                                            ${skill.name}
                                        </h3>
                                        <p class="text-secondary" style="font-size: 0.875rem">
                                            ${skill.tagline}
                                        </p>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ===== SKILL OPTIONS =====
        function showSkillOptions(skillId) {
            const skill = window.skills.find(s => s.id === skillId);
            
            showModal(`
                <div style="text-align: center">
                    <div style="font-size: 3rem; margin-bottom: 1rem">${skill.icon}</div>
                    <h2 class="text-primary" style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem">${skill.name}</h2>
                    <p class="text-secondary" style="margin-bottom: 1.5rem">${skill.tagline}</p>
                    
                    <div style="text-align: center; margin-bottom: 1.5rem">
                        <p class="text-secondary" style="font-size: 1rem; line-height: 1.6">${skill.description}</p>
                    </div>
                    
                    <div style="display: grid; gap: 0.75rem">
                        <button onclick="startLearningSkill('${skillId}')" class="btn-primary">
                            Learn This Skill
                        </button>
                        
                        <button onclick="practiceSkill('${skillId}')" style="width: 100%; padding: 1rem; border-radius: 1rem; background: rgba(14, 116, 144, 0.12); border: 1px solid rgba(14, 116, 144, 0.35); color: rgb(165, 243, 252); font-weight: 600; font-size: 1rem; cursor: pointer">
                            Practice Now (${skill.practiceDuration}s)
                        </button>
                        
                        <button onclick="closeModal()" style="width: 100%; padding: 0.75rem; border-radius: 0.75rem; background: transparent; color: rgb(148, 163, 184); font-weight: 500; border: none; font-size: 0.875rem; cursor: pointer">
                            Cancel
                        </button>
                    </div>
                </div>
            `);
        }

        function startLearningSkill(skillId) {
            closeModal();
            state.currentSkill = skillId;
            state.currentStep = 1;
            state.currentTab = 'lesson';
            saveState();
            renderLesson();
        }

        function practiceSkill(skillId) {
            closeModal();
            state.currentSkill = skillId;
            state.currentTab = 'practice';
            saveState();
            renderPractice();
        }

        // ===== LESSON SYSTEM =====
        function renderLesson() {
            const skill = window.skills.find(s => s.id === state.currentSkill);
            const lesson = window.lessonSteps[state.currentSkill];
            
            if (!skill || !lesson) {
                switchTab('home');
                return;
            }
            
            const currentStep = lesson.steps[state.currentStep - 1];
            const totalSteps = lesson.steps.length;
            
            // Get the step renderer for this skill and step
            const stepRenderer = window.stepRenderers[state.currentSkill] || renderDefaultStep;
            const stepContent = stepRenderer(state.currentStep);
            
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="step-transition">
                    <div class="card" style="padding:1rem;margin-bottom:1rem">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
                            <button onclick="switchTab('home')" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:0.25rem">‚Üê</button>
                            <h1 class="text-primary" style="font-weight:600;font-size:1.125rem">${currentStep.title}</h1>
                            <div class="text-muted" style="font-size:0.875rem">${state.currentStep}/${totalSteps}</div>
                        </div>
                        <div class="progress-dots">
                            ${Array(totalSteps).fill().map((_, i) => `<div class="progress-dot ${i < state.currentStep ? 'active' : ''}"></div>`).join('')}
                        </div>
                    </div>
                    
                    ${stepContent}
                    
                    <button onclick="nextLessonStep()" class="btn-primary" style="margin:1.5rem 0">
                        ${state.currentStep < totalSteps ? 'Continue ‚Üí' : 'Finish Lesson'}
                    </button>
                </div>
            `;
            
            // Setup interactive elements
            if (state.currentSkill === 'observe' && state.currentStep === 2) {
                setTimeout(() => {
                    const timerButton = document.getElementById('timerButton');
                    if (timerButton) {
                        timerButton.onclick = function() {
                            startTimer(30, 'timerDisplay', timerButton);
                        };
                    }
                }, 100);
            }
        }

        // ===== STEP RENDERERS =====
        window.stepRenderers = {
            observe: function(step) {
                const steps = [
                    // Step 1
                    `
                        <div class="card skill-header" style="padding:2rem;text-align:center;margin-bottom:1rem">
                            <div style="font-size:4rem;margin-bottom:1rem;animation:pulse 2s infinite">üåÄ</div>
                            <h2 style="color:white;font-size:1.75rem;font-weight:700;margin-bottom:1rem">Quick Question</h2>
                            <p style="color:rgba(255,255,255,0.95);font-size:1.125rem;line-height:1.6;margin-bottom:1.25rem">Right now, in this exact moment...</p>
                            <p style="color:white;font-size:1.375rem;font-weight:600;line-height:1.6;margin-bottom:1.5rem">Can you stop your thoughts?</p>
                            <p class="text-primary" style="font-size:1.05rem;line-height:1.7;margin-bottom:1.5rem">Not "think less" or "think calmer."<br/>Completely. Stop. Thinking.</p>
                            <p class="text-secondary" style="font-size:1rem;line-height:1.7;margin-bottom:1.5rem">Most people say "yes." But they've never actually tried...</p>
                            <div class="insight-badge" style="display:inline-block;margin-top:0.5rem;background:rgba(14,116,144,0.18);border:1px solid rgba(14,116,144,0.35);padding:0.5rem 1rem;border-radius:2rem;font-size:0.875rem;color:rgb(165,243,252);font-weight:500">Discover a key insight</div>
                        </div>
                    `,
                    // Step 2
                    `
                        <div class="card" style="padding:1.5rem;margin-bottom:1rem;background:linear-gradient(135deg,rgba(239,68,68,0.18),rgba(220,38,38,0.12));border:1px solid rgba(239,68,68,0.35)">
                            <div style="font-size:3rem;margin-bottom:0.75rem;text-align:center">‚ö†Ô∏è</div>
                            <h2 class="text-primary" style="font-size:1.5rem;font-weight:600;margin-bottom:1rem;text-align:center">The Challenge</h2>
                            <p class="text-primary" style="text-align:center;font-size:1.05rem;line-height:1.7">For the next 30 seconds, your job is to <strong style="color:rgb(252,165,165)">completely stop thinking</strong>.</p>
                        </div>
                        
                        <div id="timerSection" class="card" style="padding:2rem;margin-bottom:1rem;text-align:center">
                            <div class="timer-display" id="timerDisplay" style="margin-bottom:1rem">30</div>
                            <p class="text-secondary" style="margin-bottom:1.5rem;font-size:1rem">Ready? Take a breath...</p>
                            <button id="timerButton" class="btn-primary" style="font-size:1.125rem">Start Challenge</button>
                        </div>
                    `,
                    // Step 3
                    `
                        <div class="card" style="padding:2rem;margin-bottom:1rem;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.35)">
                            <div style="font-size:3.5rem;margin-bottom:1rem;text-align:center">üß†</div>
                            <h2 style="color:white;font-size:1.75rem;font-weight:700;text-align:center;margin-bottom:1rem">You Didn't Fail</h2>
                            <p style="color:rgb(134,239,172);text-align:center;font-size:1.125rem;font-weight:600">The challenge was impossible.</p>
                        </div>
                        
                        <div class="card" style="padding:1.75rem;margin-bottom:1rem">
                            <div style="background:rgba(14,116,144,0.12);padding:1.25rem;border-radius:1rem;border-left:4px solid rgb(14,116,144);margin-bottom:1.25rem">
                                <p style="color:rgb(165,243,252);font-weight:600;font-size:1.125rem;margin-bottom:0.75rem">Your brain produces 6,000+ thoughts per day</p>
                                <p class="text-secondary" style="font-size:1rem">Automatically. Without your permission.</p>
                            </div>
                            
                            <div style="background:rgba(217,119,6,0.12);padding:1.25rem;border-radius:1rem;border-left:4px solid rgb(217,119,6);margin-bottom:1.25rem">
                                <p style="color:rgb(253,230,138);font-weight:600;font-size:1.125rem;margin-bottom:0.75rem">Trying to stop thoughts = trying to stop your heart</p>
                                <p class="text-secondary" style="font-size:1rem">It's not under your conscious control.</p>
                            </div>
                        </div>
                    `,
                    // Step 4
                    `
                        <div class="card skill-header" style="padding:1.5rem;margin-bottom:1rem">
                            <h2 style="color:white;font-size:1.5rem;font-weight:700;text-align:center">Two Ways to Handle Thoughts</h2>
                            <p style="color:rgba(255,255,255,0.9);text-align:center;font-size:0.9375rem;margin-top:0.5rem">Side-by-side comparison</p>
                        </div>
                        
                        <div class="card" style="padding:1.5rem;margin-bottom:1rem;border:2px solid rgba(239,68,68,0.45);background:rgba(239,68,68,0.08)">
                            <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.25rem">
                                <div style="font-size:2rem">‚ùå</div>
                                <div>
                                    <h3 style="color:rgb(248,113,113);font-weight:600;font-size:1.25rem">FIGHTER MODE</h3>
                                    <p style="color:rgb(252,165,165);font-size:0.875rem;font-weight:500">The painful default</p>
                                </div>
                            </div>
                            
                            <div class="text-secondary" style="margin-bottom:1.25rem">
                                ${['Anxious thought appears', '"Stop thinking that!"', 'Try to suppress it', 'Thought gets stronger', 'Fight harder', 'Exhaustion + overwhelm'].map((step, i) => `
                                    <div style="display:flex;gap:0.75rem;margin-bottom:1rem">
                                        <div style="width:1.75rem;height:1.75rem;background:rgba(239,68,68,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;color:rgb(248,113,113);font-size:0.8125rem;font-weight:700;flex-shrink:0">${i+1}</div>
                                        <p style="padding-top:0.125rem;font-size:1rem">${step}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card" style="padding:1.5rem;margin-bottom:1rem;border:2px solid rgba(34,197,94,0.45);background:rgba(34,197,94,0.08)">
                            <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.25rem">
                                <div style="font-size:2rem">‚úÖ</div>
                                <div>
                                    <h3 style="color:rgb(134,239,172);font-weight:600;font-size:1.25rem">OBSERVER MODE</h3>
                                    <p style="color:rgb(74,222,128);font-size:0.875rem;font-weight:500">The skillful choice</p>
                                </div>
                            </div>
                            
                            <div class="text-secondary" style="margin-bottom:1.25rem">
                                ${['Anxious thought appears', '"Hmm, there\'s anxiety"', 'Watch it like a cloud', 'It drifts and fades', 'Return to now', 'Calm + spacious'].map((step, i) => `
                                    <div style="display:flex;gap:0.75rem;margin-bottom:1rem">
                                        <div style="width:1.75rem;height:1.75rem;background:rgba(34,197,94,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;color:rgb(134,239,172);font-size:0.8125rem;font-weight:700;flex-shrink:0">${i+1}</div>
                                        <p style="padding-top:0.125rem;font-size:1rem">${step}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `,
                    // Step 5
                    `
                        <div class="card skill-header" style="padding:1.75rem;margin-bottom:1rem">
                            <div style="font-size:3rem;margin-bottom:0.75rem;text-align:center">üßò</div>
                            <h2 style="color:white;font-size:1.5rem;font-weight:700;text-align:center;margin-bottom:0.5rem">Now, Try the Right Way</h2>
                            <p style="color:rgba(255,255,255,0.9);text-align:center;font-size:1rem">60 seconds of Observer Mode</p>
                        </div>
                        
                        <div id="practiceTimer" class="card" style="padding:2rem;margin-bottom:1rem;text-align:center;background:linear-gradient(135deg,rgba(14,116,144,0.08),rgba(217,119,6,0.08))">
                            <div class="timer-display" id="practiceDisplay" style="margin-bottom:1rem">60</div>
                            <div id="practicePrompt" style="min-height:3.5rem;display:flex;align-items:center;justify-content:center;margin-bottom:1.5rem">
                                <p style="color:rgb(165,243,252);font-style:italic;font-size:1.05rem;font-weight:500">Find a comfortable position...</p>
                            </div>
                            <button id="practiceButton" onclick="startPracticeTimer(60)" class="btn-primary" style="font-size:1.125rem">Begin Practice</button>
                        </div>
                    `,
                    // Step 6
                    `
                        <div class="card skill-header" style="padding:1.75rem;margin-bottom:1rem">
                            <div style="font-size:3rem;margin-bottom:0.75rem;text-align:center">üéØ</div>
                            <h2 style="color:white;font-size:1.5rem;font-weight:700;text-align:center;margin-bottom:0.5rem">Use It in Real Life</h2>
                            <p style="color:rgba(255,255,255,0.9);text-align:center;font-size:1rem">Your mission for today</p>
                        </div>
                        
                        <div class="card" style="padding:1.75rem;margin-bottom:1rem;background:linear-gradient(to right,rgba(251,191,36,0.12),rgba(245,158,11,0.12));border:2px solid rgba(251,191,36,0.4)">
                            <div style="text-align:center;margin-bottom:1.5rem">
                                <div style="font-size:3rem;margin-bottom:0.75rem">üìã</div>
                                <h3 class="text-primary" style="font-weight:600;font-size:1.25rem;margin-bottom:1rem">Your One-Word Tool</h3>
                                <p style="color:rgb(253,224,71);font-size:1.05rem;line-height:1.7">Every time you notice an emotion today, say one word:</p>
                            </div>
                            
                            <div style="background:rgba(255,255,255,0.12);padding:1.5rem;border-radius:1rem;text-align:center;margin-bottom:1rem;border:1px solid rgba(255,255,255,0.15)">
                                <p style="color:white;font-size:1.75rem;font-weight:700">"Noticing"</p>
                            </div>
                        </div>
                    `,
                    // Step 7
                    `
                        <div class="card" style="padding:2rem;margin-bottom:1rem;text-align:center;background:linear-gradient(135deg,rgba(14,116,144,0.1),rgba(217,119,6,0.07));border:1px solid rgba(14,116,144,0.25)">
                            <div style="font-size:4rem;margin-bottom:1rem">üå§Ô∏è</div>
                            <h2 class="text-primary" style="font-size:1.5rem;font-weight:600;margin-bottom:1rem">The Understanding You've Gained</h2>
                            
                            <div class="text-secondary" style="margin-bottom:1.5rem;text-align:left">
                                ${[
                                    '‚Ä¢ Fighting thoughts makes them stronger',
                                    '‚Ä¢ Observing creates space and calm', 
                                    '‚Ä¢ You are the sky, not the clouds',
                                    '‚Ä¢ "Noticing" is your new mindfulness tool'
                                ].map(item => `
                                    <div style="display:flex;gap:1rem;margin-bottom:1rem;align-items:start">
                                        <span style="color:rgb(134,239,172);font-weight:700;margin-top:0.125rem;flex-shrink:0">‚úì</span>
                                        <span style="font-size:1rem">${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `
                ];
                
                return steps[step - 1] || '';
            }
        };

        function renderDefaultStep(step) {
            const skill = window.skills.find(s => s.id === state.currentSkill);
            const lesson = window.lessonSteps[state.currentSkill];
            const currentStep = lesson.steps[step - 1];
            
            return `
                <div class="card" style="padding:1.5rem;margin-bottom:1rem">
                    <div class="text-secondary" style="font-size:1.125rem;line-height:1.7">
                        ${currentStep.content}
                    </div>
                </div>
            `;
        }

        function startTimer(seconds, displayId, button) {
            let timeLeft = seconds;
            const display = document.getElementById(displayId);
            
            button.disabled = true;
            button.textContent = 'Focus...';
            button.style.opacity = '0.5';
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                display.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    button.textContent = 'Complete!';
                    setTimeout(() => {
                        button.textContent = 'Start Challenge';
                        button.disabled = false;
                        button.style.opacity = '1';
                        display.textContent = '30';
                    }, 2000);
                }
            }, 1000);
        }

        function startPracticeTimer(duration) {
            const prompts = [
                'Take a breath... settle in...',
                'Notice what thoughts are here...',
                'Label them gently... "thinking"...',
                'Watch thoughts like clouds drifting...',
                'No need to fight or fix...',
                'Just watching... just noticing...',
                'You\'re the sky, not the clouds...',
                'Let them pass by...'
            ];
            let timeLeft = duration;
            let promptIndex = 0;
            const display = document.getElementById('practiceDisplay');
            const promptEl = document.getElementById('practicePrompt');
            const button = document.getElementById('practiceButton');
            
            button.disabled = true;
            button.textContent = 'Practicing...';
            button.style.opacity = '0.5';
            promptEl.innerHTML = `<p style="color:rgb(165,243,252);font-style:italic;font-size:1.125rem;font-weight:500">${prompts[0]}</p>`;
            
            const interval = setInterval(() => {
                timeLeft--;
                display.textContent = timeLeft;
                
                if (timeLeft % 8 === 0 && promptIndex < prompts.length - 1) {
                    promptIndex++;
                    promptEl.innerHTML = `<p style="color:rgb(165,243,252);font-style:italic;font-size:1.125rem;font-weight:500">${prompts[promptIndex]}</p>`;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    promptEl.innerHTML = `<p style="color:rgb(134,239,172);font-weight:600;font-size:1.125rem">‚ú® Beautiful. Take a moment...</p>`;
                    button.textContent = 'Complete!';
                }
            }, 1000);
        }

        function nextLessonStep() {
            const lesson = window.lessonSteps[state.currentSkill];
            
            if (state.currentStep < lesson.steps.length) {
                state.currentStep++;
                saveState();
                renderLesson();
            } else {
                // Lesson completed
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                
                if (!state.userProgress[state.currentSkill]) {
                    state.userProgress[state.currentSkill] = { completed: true, date: new Date().toISOString() };
                    saveState();
                }
                
                setTimeout(() => switchTab('home'), 1500);
            }
        }

        // ===== PRACTICE TAB =====
        function renderPractice() {
            const skill = window.skills.find(s => s.id === state.currentSkill);
            const duration = skill ? skill.practiceDuration : 30;
            
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="content-wrapper">
                    <div style="margin-bottom: 2rem">
                        <button onclick="switchTab('home')" style="background: none; border: none; color: white; font-size: 1.5rem; margin-bottom: 1rem; cursor: pointer">‚Üê</button>
                        <h1 class="text-primary" style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem">
                            ${skill ? skill.name : 'Practice'}
                        </h1>
                        <p class="text-secondary" style="font-size: 1rem">
                            ${skill ? skill.tagline : 'Focus and breathe'}
                        </p>
                    </div>
                    
                    <div class="card" style="padding: 2rem; margin-bottom: 1.5rem; text-align: center">
                        <div class="timer-display" id="practiceTimerDisplay" style="margin-bottom: 1rem">${duration}</div>
                        <p class="text-secondary" style="margin-bottom: 1.5rem; font-size: 1rem">
                            Focus on your breath. When thoughts arise, just notice them.
                        </p>
                        <button id="startPracticeButton" onclick="startPracticeSession(${duration})" class="btn-primary">
                            Start Practice
                        </button>
                    </div>
                    
                    <button onclick="switchTab('home')" style="width: 100%; padding: 1rem; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.75rem; color: rgb(148, 163, 184); font-weight: 500; font-size: 0.9375rem; cursor: pointer">
                        Cancel
                    </button>
                </div>
            `;
        }

        function startPracticeSession(duration) {
            let timeLeft = duration;
            const display = document.getElementById('practiceTimerDisplay');
            const button = document.getElementById('startPracticeButton');
            
            button.disabled = true;
            button.textContent = 'Practicing...';
            button.style.opacity = '0.5';
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                display.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
                    
                    if (state.currentSkill && state.userProgress[state.currentSkill]) {
                        state.userProgress[state.currentSkill].practiced = true;
                        saveState();
                    }
                    
                    button.textContent = 'Complete!';
                    setTimeout(() => switchTab('home'), 2000);
                }
            }, 1000);
        }

        // ===== CALENDAR TAB =====
        function renderCalendar() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="content-wrapper">
                    <div style="padding: 1.5rem 0 1rem">
                        <h1 class="text-primary" style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem">
                            Calendar
                        </h1>
                        <p class="text-secondary" style="font-size: 1rem">
                            Schedule your practice
                        </p>
                    </div>
                    
                    <div class="card" style="padding: 2rem; text-align: center">
                        <div style="font-size: 4rem; margin-bottom: 1rem">üìÖ</div>
                        <h3 class="text-primary" style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem">
                            Coming Soon
                        </h3>
                        <p class="text-secondary" style="margin-bottom: 1.5rem">
                            Schedule mindfulness practices and track your consistency.
                        </p>
                        
                        <button onclick="alert('Calendar feature coming soon!')" style="padding: 0.75rem 1.5rem; background: linear-gradient(to right, #0e7490, #d97706); border: none; border-radius: 0.75rem; color: white; font-weight: 600; cursor: pointer">
                            Notify Me
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== YOU TAB =====
        function renderYou() {
            const learnedCount = Object.values(state.userProgress).filter(p => p.completed).length;
            const practicedCount = Object.values(state.userProgress).filter(p => p.practiced).length;
            
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="content-wrapper">
                    <div style="padding: 1.5rem 0 1rem">
                        <h1 class="text-primary" style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem">
                            You
                        </h1>
                        <p class="text-secondary" style="font-size: 1rem">
                            Your mindfulness journey
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem">
                        <div class="card" style="padding: 1.5rem; background: rgba(14, 116, 144, 0.1); border: 1px solid rgba(14, 116, 144, 0.2);">
                            <div class="text-teal-light" style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem">${learnedCount}</div>
                            <div class="text-secondary" style="font-size: 0.875rem">Skills Learned</div>
                        </div>
                        
                        <div class="card" style="padding: 1.5rem; background: rgba(217, 119, 6, 0.1); border: 1px solid rgba(217, 119, 6, 0.2);">
                            <div class="text-amber-light" style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem">${practicedCount}</div>
                            <div class="text-secondary" style="font-size: 0.875rem">Practices Completed</div>
                        </div>
                    </div>
                    
                    <div class="card" style="padding: 1.5rem; margin-bottom: 2rem">
                        <h2 class="text-primary" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem">
                            Journal
                        </h2>
                        
                        <p class="text-secondary" style="margin-bottom: 1rem">Reflect on your practice</p>
                        <button onclick="alert('Journal feature coming soon!')" class="btn-primary">
                            Write Entry
                        </button>
                    </div>
                    
                    <div>
                        <h2 class="text-primary" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem">
                            Settings
                        </h2>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.5rem">
                            <button onclick="alert('Notifications settings coming soon!')" class="card" style="padding: 1rem; text-align: left; border: 1px solid rgba(51, 65, 85, 0.4); color: white; font-weight: 500; cursor: pointer">
                                Notifications
                            </button>
                            
                            <button onclick="alert('Reminder settings coming soon!')" class="card" style="padding: 1rem; text-align: left; border: 1px solid rgba(51, 65, 85, 0.4); color: white; font-weight: 500; cursor: pointer">
                                Daily Reminders
                            </button>
                            
                            <button onclick="resetApp()" class="card" style="padding: 1rem; text-align: left; border: 1px solid rgba(239, 68, 68, 0.3); color: rgb(254, 202, 202); font-weight: 500; cursor: pointer; background: rgba(239, 68, 68, 0.1)">
                                Reset Progress
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function resetApp() {
            if (confirm("Are you sure you want to reset all progress? This cannot be undone.")) {
                localStorage.removeItem('mphaven_state');
                state = {
                    currentTab: 'home',
                    currentCourse: null,
                    currentSkill: null,
                    currentStep: 1,
                    userProgress: {},
                    journalEntries: [],
                    timerRunning: false
                };
                alert("App reset successfully!");
                render();
            }
        }

        // ===== INITIALIZATION =====
        function init() {
            loadState();
            render();
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
